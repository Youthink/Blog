---
title: 写给自己的JavaScript系列之闭包
date: 2019-01-16 12:57:16
updated: 2019-01-16 12:57:16
tags:
categories: 编程
---

## 什么是闭包

首先，闭包不是 JavaScript 中独有的，很多其他的编程语言中也有闭包，比如 Python、Java、Swift、PHP。

我们先一起来看几种关于闭包的定义：

> 只是看几种定义，后面会做解释，不要被这么多定义阻挡了前进的脚步。😂

[MDN 闭包:](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Closures) 

> 闭包是函数和声明该函数的词法环境的组合。

你不知道的 JavaScript:

> 当函数可以记住并访问所在的词法作用域，即使函数是在当前词法作用域之外执行，这时就产生了闭包。

> 闭包是基于词法作用域书写代码时所产生的自然结果。

[维基百科-闭包:](https://zh.wikipedia.org/wiki/%E9%97%AD%E5%8C%85_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)) 
> 在计算机科学中，闭包（英语：Closure），又称词法闭包（Lexical Closure）或函数闭包（function closures），是引用了自由变量的函数。

JavaScript高级程序设计

> 闭包是指有权访问另一个函数作用域中的变量的函数。创建闭包的常见方式，就是在一个函数内部创建另一个函数。

JavaScript权威指南

> 暂时没有找到明确的定义

其他的定义

> 闭包是一个函数，返回值依赖于声明在函数外部的一个或多个变量。

> 闭包是一个函数，可以使用函数之外定义的变量。

## 和闭包有关的概念

上面的几种定义，提到了这么几个词：函数外的变量、自由变量、词法作用域（词法环境）。

如果对比几种定义，会发现 《JavaScript高级程序设计》 中对于闭包的解释不够准确，只是这种说法可能对新手来说，更好理解。

**TODO: 不只是可以访问另一个函数中的变量，举个例子，有没有其他的情况。**

JavaScript 闭包的本质源自两点，词法作用域和函数当作值传递。

《你不知道的 JavaScript》 中提到，如果你理解词法作用域就能理解闭包。

### 什么是词法作用域？

和其他大多数现代编程语言一样，JavaScript 也采用词法作用域（lexical scoping），也就是说，函数的执行依赖于变量作用域，这个作用域是在**函数定义**时决定的，而不是函数调用时决定的。为了实现这种词法作用域，JavaScript函数对象的内部状态不仅包含函数的代码逻辑，还必须引用当前的作用域链。

词法作用域的基本规则：JavaScript函数的**执行**用到了作用域链，这个作用域链是函数定义的时候创建的。简言之，闭包的这个特性强大到让人吃惊：它们可以捕捉到局部变量（和参数），并一直保存下来，看起来像这些变量绑定到了在其中定义它们的外部函数。

如果你理解了词法作用域的规则，你就能很容易地理解闭包：函数定义时的作用域链到函数执行时依然有效。

我们将作用域链描述为一个对象列表，不是绑定的栈。每次调用JavaScript函数的时候，都会为之创建一个新的对象用来保存局部变量，把这个对象添加至作用域链中。当函数返回的时候，就从作用域链中将这个绑定变量的对象删除。如果不存在嵌套的函数，也没有其他引用指向这个绑定对象，它就会被当做垃圾回收掉。如果定义了嵌套的函数，每个嵌套的函数都各自对应一个作用域链，并且这个作用域链指向一个变量绑定对象。但如果这些嵌套的函数对象在外部函数中保存下来，那么它们也会和所指向的变量绑定对象一样当做垃圾回收。**但是如果这个函数定义了嵌套的函数，并将它作为返回值返回或者存储在某处的属性里，这时就会有一个外部引用指向这个嵌套的的函数。**它就不会被当做垃圾回收，并且它所指向的变量绑定对象也不会被当做垃圾回收。

摘录自《JavaScript权威指南 第6版》8.6节 闭包

上面这一堆自己解释一下就是：函数执行的时候是从函数定义的时的作用域链上去找变量。

### 自由变量

什么是自由变量？举个例子，add (x,y) = x+y+z 在函数 add 中，x和y是约束变量，z为自由变量。在函数add中，x和y是约束变量，z为自由变量。同样在一个代码块中，如果某个变量在这个代码块中没被定义过，那么这个变量就可以被认为是一个自由变量。在定义了自由变量的基础上，我们可以来定义闭包了。很简单，一句话，定义中含有自由变量的函数叫闭包。前面提到的 add 函数就是一个闭包，因为它含有自由变量z。


[我们现在写一个函数 f (x) = a + x 这个函数是不完整的，我们不知道 a 是多少？比如 f (1) = a + 1

有两个方法回答这个问题第一种叫“动态作用域”，a的值决定于函数调用时上下文中a的值，比如a = 1；v=f(1) ； 这里v为2动态作用域的问题是，函数每一次调用相同的参数未必返回相同的值，其返回值还取决于上下文的某些值第二种是“词法作用域”，a的值取决于函数定义时上下文中的值g (a) = lambda (x) a + x；f = g(2)这里函数g返回一个和上面函数f形式一样函数，a在此处为2，那么执行a = 1；v=f(1) ；这里v为3因为f要“记住”自己定义时a的值为2，所以实现时 f (x) = a + x 和 a = 2 被打包在一块，被称为“闭包”，意思是它是完整独立的，仅仅依靠调用时参数求值，不再依赖调用时的上下文晕，写完以后才发现我也写了不少...](假设你现在有一个函数  f (x) = a + x 这个函数是不完整的，比如 f (1) = a + 1 你还差一个问题: a 是多少？有两个方法回答这个问题第一种叫“动态作用域”，a的值决定于函数调用时上下文中a的值，比如a = 1；v=f(1) ； 这里v为2动态作用域的问题是，函数每一次调用相同的参数未必返回相同的值，其返回值还取决于上下文的某些值第二种是“词法作用域”，a的值取决于函数定义时上下文中的值g (a) = lambda (x) a + x；f = g(2)这里函数g返回一个和上面函数f形式一样函数，a在此处为2，那么执行a = 1；v=f(1) ；这里v为3因为f要“记住”自己定义时a的值为2，所以实现时 f (x) = a + x 和 a = 2 被打包在一块，被称为“闭包”，意思是它是完整独立的，仅仅依靠调用时参数求值，不再依赖调用时的上下文

作者：baozii
链接：https://www.zhihu.com/question/21865351/answer/20823147
来源：**知乎**

## 闭包的特性

之后要在总结一下

1.函数内再嵌套函数

2.内部函数可以引用外层的参数和变量

3.参数和变量不会被垃圾回收机制回收

## 怎么识别闭包

1、使用了回调函数，实际上就是在使用闭包。

2、函数使用了函数外的变量

## 闭包的应用

2、最常见的例子，循环中的闭包（你不知道的 js 48页例子）

1、隐藏变量

以下示例，引用自方应杭的[「每日一题」JS 中的闭包是什么？](https://zhuanlan.zhihu.com/p/22486908?refer=study-fe)

假设我们在做一个游戏，在写其中关于「还剩几条命」的代码。

如果不用闭包，你可以直接用一个全局变量：

```js
window.lives = 30 // 还有三十条命
```
这样看起来很不妥。万一不小心把这个值改成 -1 了怎么办。所以我们不能让别人「直接访问」这个变量。怎么办呢？

闭包通常用来创建内部变量，使得这些变量不能被外部随意修改，同时又可以通过指定的函数接口来操作。

用局部变量。

但是用局部变量别人又访问不到，怎么办呢？

暴露一个访问器（函数），让别人可以「间接访问」。

代码如下：

```js
!function(){

  var lives = 50

  window.奖励一条命 = function(){
    lives += 1
  }

  window.死一条命 = function(){
    lives -= 1
  }

}()
```

实现模块（你不知道的 js ）

模拟块级作用域 （高级程序设计）

常见的用法 https://github.com/gnipbao/iblog/issues/9

[用闭包模拟私有方法](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Closures#Emulating_private_methods_with_closures)
## 参考和扩展阅读

* [MDN 闭包](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Closures)
* [深入理解JavaScript闭包(closure)](https://web.archive.org/web/20100825182303/http://www.felixwoo.com/archives/247)
* [破解前端面试（80% 应聘者不及格系列）：从 闭包说起](https://zhuanlan.zhihu.com/p/25855075)
* [【译】深入学习JavaScript闭包](https://zhuanlan.zhihu.com/p/25550867)

## 文章整理流程

1、先把这篇文章上的内容整理，补充完。

2、把 js 高级程序设计、你不知道的 js、权威指南相关部分看完。然后补充代码示例

3、然后列一个大纲，讲给小秋秋听。

4、之后遇到讲解 js 闭包的文章，看看人家怎么讲的，对比一下。

5、如果之后学习其他语言的闭包，对比一下。

## 最近发现的关于闭包的文章

[现代 JavaScript 教程](https://zh.javascript.info/closure)
[JavaScript深入之闭包](https://github.com/mqyqingfeng/Blog/issues/9)
